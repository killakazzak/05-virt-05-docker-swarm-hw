users:
  - name: tenda
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

runcmd:
  - apt-get update
  - apt-get install -y apt-transport-https ca-certificates curl software-properties-common
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
  - add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" -y
  - apt-get update
  - apt-get install -y docker-ce
  - systemctl start docker
  - systemctl enable docker
  - |
    if [ "$HOSTNAME" == "vm-1" ]; then
        docker swarm init --advertise-addr $(hostname -I | awk '{print $1}')
    else
        TOKEN=$(ssh -o StrictHostKeyChecking=no -i /path/to/your/private/key tenda@vm-1 "docker swarm join-token worker -q")
        docker swarm join --token $TOKEN vm-1:2377
    fi
